<!doctype html>
<html lang="en-us">
  <head>
    <title>Smart Way to do Regex // Council of Elrond</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.118.2">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Song Kou" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Smart Way to do Regex"/>
<meta name="twitter:description" content="Below is a sample code that I found to get complex regex pattern instead of write it manually good example to make smaller parts first the combine to a very complex pattern.
import re
# convert the {name} test to rules in predefined format in macros def regex_expand(macros, pattern, guarded = True): output = [] pos = 0 size = len(pattern) while pos &lt; size: ch = pattern[pos] if ch == &#39;\\&#39;: output."/>

    <meta property="og:title" content="Smart Way to do Regex" />
<meta property="og:description" content="Below is a sample code that I found to get complex regex pattern instead of write it manually good example to make smaller parts first the combine to a very complex pattern.
import re
# convert the {name} test to rules in predefined format in macros def regex_expand(macros, pattern, guarded = True): output = [] pos = 0 size = len(pattern) while pos &lt; size: ch = pattern[pos] if ch == &#39;\\&#39;: output." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://songkou.github.io/posts/smart_way_do_regex/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-06T23:23:10+08:00" />
<meta property="article:modified_time" content="2023-10-06T23:23:10+08:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://songkou.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Song Kou" /></a>
      <span class="app-header-title">Council of Elrond</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/categories/">Categories</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>ignorance more frequently begets confidence than does knowledge</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Smart Way to do Regex</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 6, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://songkou.github.io/tags/python/">Python</a>
              <a class="tag" href="https://songkou.github.io/tags/regex/">Regex</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>Below is a sample code that I found to get complex regex pattern instead of write it manually
good example to make smaller parts first the combine to a very complex pattern.</p>
<p>import re</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># convert the {name} test to rules in predefined format in macros</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">regex_expand</span>(macros, pattern, guarded <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> len(pattern)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> pos <span style="color:#f92672">&lt;</span> size:
</span></span><span style="display:flex;"><span>        ch <span style="color:#f92672">=</span> pattern[pos]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#39;</span>:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(pattern[pos:pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> ch <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;{&#39;</span>:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(ch)
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        p2 <span style="color:#f92672">=</span> pattern<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;}&#39;</span>, pos)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> p2 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(ch)
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> p2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> pattern[pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>:p2]<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\t</span><span style="color:#e6db74"> &#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(pattern[pos:p3])
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> p3
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> name[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>isdigit():
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(pattern[pos:p3])
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> p3
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> (<span style="color:#e6db74">&#39;&lt;&#39;</span> <span style="color:#f92672">in</span> name) <span style="color:#f92672">or</span> (<span style="color:#e6db74">&#39;&gt;&#39;</span> <span style="color:#f92672">in</span> name):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;invalid pattern name &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#f92672">%</span>name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> name <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> macros:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;{</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">} is undefined&#39;</span><span style="color:#f92672">%</span>name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> guarded:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;(?:&#39;</span> <span style="color:#f92672">+</span> macros[name] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            output<span style="color:#f92672">.</span>append(macros[name])
</span></span><span style="display:flex;"><span>        pos <span style="color:#f92672">=</span> p3
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># given a set of rules, create rules dictionary</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">regex_build</span>(code, macros <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, capture <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    defined <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> macros <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> macros<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            defined[k] <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>    line_num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> code<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>):
</span></span><span style="display:flex;"><span>        line_num <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\t</span><span style="color:#e6db74"> &#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">not</span> line) <span style="color:#f92672">or</span> line<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;#&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        pos <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;=&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: not a valid rule&#39;</span><span style="color:#f92672">%</span>line_num)
</span></span><span style="display:flex;"><span>        head <span style="color:#f92672">=</span> line[:pos]<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\t</span><span style="color:#e6db74"> &#39;</span>)
</span></span><span style="display:flex;"><span>        body <span style="color:#f92672">=</span> line[pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>:]<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\t</span><span style="color:#e6db74"> &#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">not</span> head):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: empty rule name&#39;</span><span style="color:#f92672">%</span>line_num)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> head[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>isdigit():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: invalid rule name &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#f92672">%</span>(line_num, head))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> (<span style="color:#e6db74">&#39;&lt;&#39;</span> <span style="color:#f92672">in</span> head) <span style="color:#f92672">or</span> (<span style="color:#e6db74">&#39;&gt;&#39;</span> <span style="color:#f92672">in</span> head):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: invalid rule name &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#f92672">%</span>(line_num, head))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            pattern <span style="color:#f92672">=</span> regex_expand(defined, body, guarded <span style="color:#f92672">=</span> <span style="color:#f92672">not</span> capture)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>(line_num, str(e)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            re<span style="color:#f92672">.</span>compile(pattern)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> re<span style="color:#f92672">.</span>error:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">: invalid pattern &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#f92672">%</span>(line_num, pattern))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> capture:
</span></span><span style="display:flex;"><span>            defined[head] <span style="color:#f92672">=</span> pattern
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            defined[head] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;(?P&lt;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&gt;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#39;</span><span style="color:#f92672">%</span>(head, pattern)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># define a set of rules</span>
</span></span><span style="display:flex;"><span>rules <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    protocol = http|https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    login_name = [^:@\r\n\t ]+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    login_pass = [^@\r\n\t ]+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    login = </span><span style="color:#e6db74">{login_name}</span><span style="color:#e6db74">(:</span><span style="color:#e6db74">{login_pass}</span><span style="color:#e6db74">)?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    host = [^:/@\r\n\t ]+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port = \d+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    optional_port = (?:[:]</span><span style="color:#e6db74">{port}</span><span style="color:#e6db74">)?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path = /[^\r\n\t ]*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url = </span><span style="color:#e6db74">{protocol}</span><span style="color:#e6db74">://(</span><span style="color:#e6db74">{login}</span><span style="color:#e6db74">[@])?</span><span style="color:#e6db74">{host}{optional_port}{path}</span><span style="color:#e6db74">?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># convert above rules to dictionary</span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> regex_build(rules, capture <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print dictionary info</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> m<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    print(k, <span style="color:#e6db74">&#39;=&#39;</span>, v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># use final rule &#34;url&#34; to regex a text</span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> m[<span style="color:#e6db74">&#39;url&#39;</span>]
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(pattern, <span style="color:#e6db74">&#39;https://name:pass@www.test.com:8080/abcdefg&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print the complete list of matches</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;matched: &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#f92672">%</span>s<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>print()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print the matched items based on rule defined names</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;url&#39;</span>, <span style="color:#e6db74">&#39;login_name&#39;</span>, <span style="color:#e6db74">&#39;login_pass&#39;</span>, <span style="color:#e6db74">&#39;host&#39;</span>, <span style="color:#e6db74">&#39;port&#39;</span>, <span style="color:#e6db74">&#39;path&#39;</span>):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;subgroup:&#39;</span>, name, <span style="color:#e6db74">&#39;=&#39;</span>, s<span style="color:#f92672">.</span>group(name))
</span></span></code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
